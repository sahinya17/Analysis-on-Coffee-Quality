---
title: "Analysing Coffee"
subtitle: ETC5513 Assignment 4, Master of Business Analytics
author: Yiwen Liu, Panagiotis Stylianos, Sahinya Akila
date: '`r Sys.Date()`'
output: 
  html_document:
    css: monashreport.css
    includes:
      before_body: header.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r reading-data}
# Get the Data
coffee_data <- read_csv(here::here("Data/coffee_ratings.csv"))
```

# Introduction 

# Section 1 - Q1 & 2

## How many bags of coffee from each country were sampled? 

We begin our analysis by providing a summary of the samples used to provide the coffee ratings. For each country different varieties of coffee were sampled from different regions and companies. The samples from each country can be summarised using the number_of_bags variable.
It is important to know the total quantity for each country to possibly identify a relationship between the number of samples used and the countries rating.

```{r bags}
library(tidyverse)
library(leaflet)

# count bags per country
country_bags <- coffee_data %>% 
  group_by(country_of_origin) %>% 
  summarise(total_bags = sum(number_of_bags)) %>% 
  arrange(desc(total_bags)) 

# obtain coordinates
country_coord <- map_data("world") %>% 
  group_by(region) %>% 
  summarise(mean_long = mean(long, na.rm = TRUE),
            mean_lat = mean(lat, na.rm = TRUE))

# join data
country_bags <- country_bags %>% 
  left_join(
    country_coord,
    by = c("country_of_origin" = "region")
  )


mapCountry<- maps::map("world", fill = TRUE, plot = FALSE)  

pal_fun <- colorQuantile("YlOrRd", NULL, n = 7)

total_bags <- country_bags$total_bags[match(mapCountry$names, country_bags$country_of_origin)] 
```

```{r, bagmap}
leaflet(mapCountry) %>% # create a blank canvas
  addProviderTiles("NASAGIBS.ViirsEarthAtNight2012") %>%
  addPolygons( # draw polygons on top of the base map (tile)
    stroke = FALSE, 
    smoothFactor = 0.2, 
    fillOpacity = 1,
    color = ~pal_fun(total_bags)
  ) %>% 
  addCircles(data = country_bags, 
             lat = ~mean_lat, 
             lng =~mean_long, 
             radius = total_bags,
             layerId = country_bags$country_of_origin,
             weight = log(total_bags), 
             stroke = T,  
             fillColor = "white", 
             color = "black", 
             fillOpacity = 3,
             label = paste("Total bags of coffe tested in", 
                           country_bags$country_of_origin, ":", country_bags$total_bags),
             labelOptions = labelOptions(noHide = F, textsize = "15px"),
             popupOptions = country_bags$country_of_origin)
```

The below table summarises the total bags counted for each country.

```{r bagtable}
DT::datatable(
country_bags %>% 
  select(country_of_origin, total_bags),
colnames = c("Country", "Total Bags"),
caption = "Total Bags of Coffee sampled by Country"
)
```

We observe that more than 40000 samples of Colombian coffee were used for grading.

```{r cor, fig.cap="Scatterplot of average coffee rating and number of testing samples"}
coffee_data %>% 
  group_by(country_of_origin) %>% 
  summarise(total_bags = sum(number_of_bags),
            avg_rating = mean(total_cup_points, na.rm = TRUE)) %>% 
  ggplot(aes(total_bags, avg_rating)) +
  geom_point() +
  theme_classic() +
  labs(
    x = "Total Bags",
    y = "Average Coffee Rating",
    title = "Association between Rating and Number of Testing Samples"
  )
```

Figure \@ref(fig:cor) indicates that there is not an apparent association between the average cofee rating and the number of testing samples.
 

## Which country produces the highest rated coffee?

```{r rating}
library(ggridges)

ggplot(coffee_data %>% filter(total_cup_points > 50), aes(x = total_cup_points, y = country_of_origin, fill = stat(x))) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01, gradient_lwd = 1.) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_discrete(expand = expand_scale(mult = c(0.01, 0.25))) +
  scale_fill_viridis_c(name = "Temp. [F]", option = "C") +
  labs(
    title = 'Coffee Rating Distribution'
  ) +
  theme_ridges(font_size = 10, grid = TRUE) + 
  theme(axis.title.y = element_blank())
```


```{r ratingdist}
ggplot(coffee_data %>% filter(total_cup_points > 50), aes(country_of_origin , total_cup_points, fill = country_of_origin )) +
  geom_boxplot() +
  coord_flip() +
  theme(legend.position = "none") 
```



# Section 2 - Q3 & 4

# Section 3 - Q5 & 6

#Conclusion

